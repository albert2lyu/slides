<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Remark</title>
    <link rel="stylesheet" type="text/css" href="../remark-theme-dark.css" />
    <script src="../remark-0.4.2.min.js" type="text/javascript">
      {"highlightStyle": "monokai"}
    </script>
    <script type="text/javascript">
      var hljs = remark.highlighter.engine();
    </script>
  </head>
  <body>
<textarea id="source">
name: inverse
layout: true
class: inverse
---
class: center middle
#Rails for Legacy Database
[greatghoul]
---
class: center middle
## Convention Over Configuration
然后，有时你不得去面对一些发酵的配置，比如，遗留数据库...
---
## 背景

公司有一个租车管理的系统，客户表示这个系统各种难用，于是重新设计，而且数据库需要兼容原版，但是工期很短，用PHP怎么都是完成不了，于是上Rails。

使用Rails的默认命名约定开发一个新项目会非常快，因为一无所有，所以无所顾忌，Rails的便利会让你顺风顺水，但当你面对一个前人留下的庞然大物时，而你没有办法去改变它，而只能去适应时，Rails 就没有想象中的那么快了（其实还是比一些语言快）

遗留问题永远都是一个让人头疼的问题，遗留数据库也不例外，尤其是设计糟糕的遗留库，而且你不能改变它，因为 **It still works!**


.footnote[.red[#] Ruby and Rails Naming Conventions - http://itsignals.cascadia.com.au/?p=7 ]
---
## 那么遗留数据库有哪些痛

### - **表名的差异**
### - 主键的差异
### - 时间戳的差异
### - 实体关系

---
## 表名的差异

不同的 ``DBA`` 数据库表的命名方式真的千差万别

    create table driver(...);
    create table reservationdetail(...);
    create table person(...);

而 ``Rails`` 默认是这样

    Driver ................ drivers
    ReservationDetail ..... reservation_details
    Person ................ people

**其它**：表前缀(如 ``wp_``) 或后缀 (如 ``_tb``)

这里且不论哪种表名更加**优雅**，``Rails`` 很方便，但它显然不能适应所有 ``DBA`` 的哲学，所以默认规则这里显然是不能用了。
---
## 表名的差异 - 实践
.left-column[
### - 全部单数
]
.right-column[
[指导](http://guides.rubyonrails.org/configuring.html#configuring-active-record)
]
---
## 表名的差异 - 实践
.left-column[

### - 全部单数  
### - 少量单数

]
.right-column[
`migration` 

    class CreateGroups < ActiveRecord::Migration
      def change
        create_table :groups do |t|
            # ...
        end
      end
      rename_table :groups, :group
    end

或者

    create_table :groups do |t|
        # ...
    end
    
`model`

    class Group < ActiveRecord::Base
      self.table_name = :group
      # attr_accessible .... 
    end      
    
]
---
## 表名的差异 - 实践
.left-column[
### - 全部单数  
### - 少量单数
### - 前缀后缀
]
.right-column[
``Wordpress``, CMD
]
---
## 那么遗留数据库有哪些痛

### - 表名的差异
### - **主键的差异**
### - 时间戳的差异
### - 实体关系
---
## 主键的差异

### 命名

表名: ``reservation_detail``  
主键: ``reservation_detail_id`` vs ``id``

### 类型

UUID、按规则拼接、复合主键

---
## 主键的差异 - 实践
.left-column[

### - 名称差异 

]
.right-column[
`migration` 

    class createreservationdetails < activerecord::migration
      def change
        create_table :reservation_details, 
                     :primary_key=>:reservation_detail_id do |t|
          # attributes ...
        end
        # ... 
      end
    end
    
`model`

    class reservationdetail < activerecord::base
      # ...
      self.primary_key = :reservation_detail_id
      alias_attribute :reservation_detail_id, :id
      # attr_accessible .... 
    end      
    
]
---
## 主键的差异 - 实践
.left-column[

### - 名称差异 
### - 类型差异 

]
.right-column[
非默认类型主键无法识别

`migration` 

    class CreateDetails < ActiveRecord::Migration
      def change
        create_table :details, :id => false do |t|
          t.string, :code
          # attributes ...
        end
        execute 'ALTER TABLE details ADD PRIMARY KEY(code);'
        # ... 
      end
    end
    
`model`

    class Detail < ActiveRecord::Base
      # ..
      self.primary_key = :code
      # attr_accessible .... 
    end      
    
]
---
## 主键的差异 - 实践
.left-column[

### - 名称差异 
### - 类型差异 
### - UUID 

]
.right-column[
[通用唯一识别码 (Universally Unique Identifier, UUID)](http://zh.wikipedia.org/wiki/UUID) 标准类型包含32个16进位数字，以连字号分为五段，形式为8-4-4-4-12的32个字符。示例； ``550e8400-e29b-41d4-a716-446655440000`` 

`lib/uuid_helper.rb`

    require 'rubygems'
    require 'uuidtools'

    module UUIDHelper
      def before_create()
        self.id = UUID.timestamp_create().to_s
      end
    end

`migration & model` 
    # migration
    create_table :details, :id => false do |t|
      t.string, :id, :limit => 32
    end
    execute 'ALTER TABLE details ADD PRIMARY KEY(id);'

    # model
    class Detail < ActiveRecord::Base
      # attr_accessible .... 
    end      
]
---
## 那么遗留数据库有哪些痛

### - 表名的差异
### - 主键的差异
### - **时间戳的差异**
### - 实体关系
---
## 时间戳的差异

Rails默认时间戳

    created_at, updated_at

公司数据库中的时间戳

    created_date, last_modified_date

**解决方法**

``config/initializers/active_record.rb``

    module ActiveRecord
      module Timestamp      
        private
        def timestamp_attributes_for_update #:nodoc:
          [:last_modified_date, :updated_at, :updated_on, :modified_at]
        end
        def timestamp_attributes_for_create #:nodoc:
          [:create_date, :created_at, :created_on]
        end      
      end
    end
---
## 那么遗留数据库有哪些痛

### - 表名的差异
### - 主键的差异
### - 时间戳的差异
### - **实体关系**
---
## 实体关系

 ...

---
name: last-page
template: inverse

## That's all folks (for now)!

Slideshow created using [remark](http://github.com/gnab/remark).

</textarea>
<div id="slideshow"></div>
</body>
</html>
<!-- 
vim:ft=markdown
-->
