<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Remark</title>
    <link rel="stylesheet" type="text/css" href="../remark-theme-dark.css" />
    <script src="../remark-0.4.2.min.js" type="text/javascript">
      {"highlightStyle": "monokai"}
    </script>
    <script type="text/javascript">
      var hljs = remark.highlighter.engine();
    </script>
  </head>
  <body>
<textarea id="source">
name: inverse
layout: true
class: inverse
---
class: center middle
#Rails for Legacy Database
[greatghoul]
---
class: center middle
## Convention Over Configuration
然后，有时你不得去面对一些发酵的配置，比如，遗留数据库...

.footnote[ .red[#] [Ruby and Rails Naming Conventions](http://itsignals.cascadia.com.au/?p=7) ]
---
## 背景

### - 老数据库
### - 不能修改
### - 命名不规范
### - 大量冗余
### - 自定规则主键
---
## 那么遗留数据库有哪些痛

### - **表名的差异**
### - 主键的差异
### - 时间戳的差异
### - 实体关系

---
## 表名的差异

不同的 ``DBA`` 数据库表的命名方式真的千差万别

    create table driver(...);
    create table order_detail(...);
    create table person(...);

而 ``Rails`` 默认是这样

    Driver ................ drivers
    OrderDetail ..... order_details
    Person ................ people

**其它**：表前缀(如 ``wp_``) 或后缀 (如 ``_tb``)

这里且不论哪种表名更加**优雅**，``Rails`` 很方便，但它显然不能适应所有 ``DBA`` 的哲学，所以默认规则这里显然是不能用了。
---
## 表名的差异 - 实践
.left-column[
### - 全部单数
]
.right-column[
[指导](http://guides.rubyonrails.org/configuring.html#configuring-active-record)
]
---
## 表名的差异 - 实践
.left-column[

### - 全部单数  
### - 少量单数

]
.right-column[
`migration` 

    class CreateGroups < ActiveRecord::Migration
      def change
        create_table :groups do |t|
            # ...
        end
      end
      rename_table :groups, :group
    end

或者

    create_table :groups do |t|
        # ...
    end
    
`model`

    class Group < ActiveRecord::Base
      self.table_name = :group
      # attr_accessible .... 
    end      
    
]
---
## 表名的差异 - 实践
.left-column[
### - 全部单数  
### - 少量单数
### - 前缀后缀
]
.right-column[
``Wordpress``, CMD
]
---
## 那么遗留数据库有哪些痛

### - 表名的差异
### - **主键的差异**
### - 时间戳的差异
### - 实体关系
---
## 主键的差异

### 命名

表名: ``detail``, ``details``  
主键: ``detail_id``, ``id``  
时间: ``create_at``, ``last_modified_date`` ...

### 类型

UUID、按规则拼接、复合主键

---
## 主键的差异 - 实践
.left-column[

### - 名称差异 

]
.right-column[
`migration` 

    class CreateDetails < ActiveRecord::Migration
      def change
        create_table :details, :primary_key => :detail_id do |t|
          # attributes ...
        end
        # ... 
      end
    end
    
`model`

    class Detail < ActiveRecord::Base
      # ...
      self.primary_key = :detail_id
      alias_attribute :detail_id, :id
      # attr_accessible .... 
    end      
    
]
---
## 主键的差异 - 实践
.left-column[

### - 名称差异 
### - 类型差异 

]
.right-column[
非默认类型主键无法识别

`migration` 

    class CreateDetails < ActiveRecord::Migration
      def change
        create_table :details, :id => false do |t|
          t.string, :code
          # attributes ...
        end
        execute 'ALTER TABLE details ADD PRIMARY KEY(code);'
        # ... 
      end
    end
    
`model`

    class Detail < ActiveRecord::Base
      # ..
      self.primary_key = :code
      # attr_accessible .... 
    end      
    
]
---
## 主键的差异 - 实践
.left-column[

### - 名称差异 
### - 类型差异 
### - UUID 

]
.right-column[
[通用唯一识别码 (Universally Unique Identifier, UUID)](http://zh.wikipedia.org/wiki/UUID) 标准类型包含32个16进位数字，以连字号分为五段，形式为8-4-4-4-12的36个字符。示例； ``550e8400-e29b-41d4-a716-446655440000`` 
_(via: [维基百科](http://zh.wikipedia.org/wiki/%E9%80%9A%E7%94%A8%E5%94%AF%E4%B8%80%E8%AF%86%E5%88%AB%E7%A0%81))_

**加入UUIDHelper**

`lib/extras/uuid_helper.rb`

    require 'rubygems'
    require 'uuidtools'

    module UUIDHelper
      def self.included(base)
        base.class_eval do
          before_create :set_guuid

          def set_guuid
            self.id = UUIDTools::UUID.random_create.to_s
          end
        end
      end
    end

`config/application.rb`

    config.autoload_paths += %W(#{config.root}/extras)
]
---
## 主键的差异 - 实践
.left-column[

### - 名称差异 
### - 类型差异 
### - UUID 

]
.right-column[
**Migration 和 Model**

`migration`

    # migration
    create_table :details, :id => false do |t|
      t.string, :id, :limit => 36
    end
    execute 'ALTER TABLE details ADD PRIMARY KEY(id);'

_根据数据库的不同，这里设置主键的语句会有变化_

`model`

    class Ietail < ActiveRecord::Base
      include UUIDHelper
      self.primary_key = :id
      # attr_accessible .... 
    end      
]
---
## 那么遗留数据库有哪些痛

### - 表名的差异
### - 主键的差异
### - **时间戳的差异**
### - 实体关系
---
## 时间戳的差异

Rails默认时间戳

    created_at, updated_at

公司数据库中的时间戳

    created_date, last_modified_date

**解决方法**

``config/initializers/active_record.rb``

    module ActiveRecord
      module Timestamp      
        private
        def timestamp_attributes_for_update #:nodoc:
          [:last_modified_date, :updated_at, :updated_on, :modified_at]
        end
        def timestamp_attributes_for_create #:nodoc:
          [:create_date, :created_at, :created_on]
        end      
      end
    end
---
## 那么遗留数据库有哪些痛

### - 表名的差异
### - 主键的差异
### - 时间戳的差异
### - **实体关系**
---
## 实体关系

 ...

---
name: last-page
template: inverse

## That's all folks (for now)!

Slideshow created using [remark](http://github.com/gnab/remark).

</textarea>
<div id="slideshow"></div>
</body>
</html>
<!-- 
vim:ft=markdown
-->
